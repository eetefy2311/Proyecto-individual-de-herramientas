---
title: "Gráficos"
format: html
---

# Primero se filtra la base de datos para dejar solo variables de interés, e incluir las delimitaciones espaciales y temporales correspondientes. 

```{r}
library(readr)

library(dplyr)

library(ggplot2)

url <- "https://raw.githubusercontent.com/eetefy2311/Data-proyecto-individual/refs/heads/main/global_bleaching_environmental%20(1).csv"

temp.file <- tempfile(fileext = ".csv")

download.file(url, destfile = temp.file, mode = "wb")

database <- read_csv(temp.file)

View(database)

base.filtrada <- database %>%
  select(Site_ID, Latitude_Degrees, Longitude_Degrees, Ocean_Name, Ecoregion_Name, Realm_Name, Exposure, Distance_to_Shore, Date_Year, Temperature_Mean, SSTA_Maximum, TSA_Mean, Turbidity, Cyclone_Frequency, Percent_Bleaching
  ) %>% 
  filter(
    Ocean_Name == "Atlantic", Date_Year >= 2000, Date_Year <= 2020) 

base.filtrada <- base.filtrada %>%
  mutate(across(
    .cols = c("Percent_Bleaching", "Distance_to_Shore", "Temperature_Mean", "SSTA_Maximum", "TSA_Mean"),
    .fns = ~ as.numeric(gsub("[^0-9\\.-]", "", .x))
  ))

View(base.filtrada)

#str(base.filtrada)

```

# Manejo de datos faltantes y outliers.

```{r}

mediana.dist <- median(base.filtrada$Distance_to_Shore, na.rm = TRUE)
mediana.blanq <- median(base.filtrada$Percent_Bleaching, na.rm = TRUE)

base.filtrada %>%
  mutate(
    Distance_to_Shore = if_else(is.na(Distance_to_Shore), mediana.dist, Distance_to_Shore),
    Percent_Bleaching = if_else(is.na(Percent_Bleaching), mediana.blanq, Percent_Bleaching),
    Exposure = if_else(is.na(Exposure), "Desconocido", Exposure)
  )
  
base.filtrada %>% 
  mutate(
    Q1 = quantile(Distance_to_Shore, 0.25, na.rm = TRUE),
    Q3 = quantile(Distance_to_Shore, 0.75, na.rm = TRUE),
    IQR_val = Q3 - Q1,
    lim.inf = Q1 - 1.5 * IQR_val,
    lim.sup = Q3 + 1.5 * IQR_val,
    Distance_to_Shore = if_else(Distance_to_Shore < lim.inf | Distance_to_Shore > lim.sup,
                                mediana.dist, Distance_to_Shore)
  )

```


# Observación general de los datos.

```{r}

str(base.filtrada)

head(base.filtrada)

```


# Graficos planteados.

## Ver el cambio en el blanqueamiento durante los ultimos años.

```{r}

promedio.anual <- base.filtrada %>%
  group_by(Date_Year) %>%
  summarise(prom.blanq = mean(Percent_Bleaching, na.rm = TRUE))

promedio.anual %>% 
  ggplot(aes(x = Date_Year, y = prom.blanq)) +
  geom_line(color = "#0077B6", size = 1.2) +
  geom_point(color = "#00B4D8", size = 2) +
  geom_smooth(method = "loess", se = FALSE, color = "#FF6B6B", linetype = "dashed") +
  scale_x_continuous(breaks = seq(2000, 2020, by = 2)) +
  labs(
    title = "Tendencia del blanqueamiento coralino en el Océano Atlántico (2000–2020)",
    x = "Año",
    y = "Porcentaje promedio de blanqueamiento (%)"
  ) +
  theme_minimal()

```

## Promedio de los porcentajes de blanqueamiento diferenciados por ecorregión.

```{r}

library(RColorBrewer)

top.ecoreg <- base.filtrada %>%
  filter(!is.na(Ecoregion_Name)) %>%
  group_by(Ecoregion_Name) %>%
  filter(n()>30) %>%
  summarise(prom.blanq = mean(Percent_Bleaching, na.rm = TRUE)) %>% 
  arrange(desc(prom.blanq)) %>%
  mutate(Ecoregion_Name = factor(Ecoregion_Name, levels = Ecoregion_Name))

cols <- rev(colorRampPalette(c("#4292C6", "#08306B"))(nrow(top.ecoreg)))

top.ecoreg %>%  
  ggplot(aes(x = Ecoregion_Name, y = prom.blanq, fill = Ecoregion_Name)) +
  geom_bar(stat = "identity", show.legend = TRUE, width = 0.7) +
  scale_fill_manual(values = cols) +  
  labs(
    title = "Promedio de blanqueamiento coralino por ecorregión (2000–2020)",
    x = "Porcentaje promedio de blanqueamiento (%)",
    y = "Ecorregión"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_blank())

```
## Distribución de registros de blanqueamiento por reino marino

```{r}
realm.pastel <- base.filtrada %>%
  filter(!is.na(Realm_Name)) %>%
  group_by(Realm_Name) %>%
  summarise(cantidad = n()) %>%
  mutate(porcentaje.pastel = round((cantidad / sum(cantidad)) * 100, 1))

realm.pastel %>% 
  ggplot(aes(x = "", y = porcentaje.pastel, fill = Realm_Name)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text(aes(label = paste0(porcentaje.pastel, "%")),
            position = position_stack(vjust = 0.3),
            color = "black",
            size = 4) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Distribución de registros de blanqueamiento por reino marino (2000–2020)",
    fill = "Reino marino"
  ) +
  theme_void()

```
## Esposición de los arrecifes

```{r}
exposicion.pastel <- base.filtrada %>%
  filter(!is.na(Exposure)) %>%
  group_by(Exposure) %>%
  summarise(cantidad = n()) %>%
  mutate(porcentaje.pastel = round((cantidad / sum(cantidad)) * 100, 1))

exposicion.pastel %>% 
  ggplot(aes(x = "", y = porcentaje.pastel, fill = Exposure)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text(aes(label = paste0(porcentaje.pastel, "%")),
            position = position_stack(vjust = 0.5),
            color = "black",
            size = 4) +
  scale_fill_brewer(palette = "Pastel1") +
  labs(
    title = "Distribución de registros por tipo de exposición (2000–2020)",
    fill = "Tipo de exposición"
  ) +
  theme_void()
```
## Distancia a la orilla en relación con el blanqueamiento

```{r}

#Creacion de categorias para mayor claridad
mediana.dist <- median(base.filtrada$Distance_to_Shore, na.rm = TRUE)

base.filtrada <- base.filtrada %>%
  mutate(
    Distance_to_Shore = ifelse(is.na(Distance_to_Shore), mediana.dist, Distance_to_Shore),
    Distancia.categoria = case_when(
      Distance_to_Shore <= 1000 ~ "Cercano a la costa (<= 1 km)",
      Distance_to_Shore > 1000 & Distance_to_Shore <= 10000 ~ "Intermedio (1–10 km)",
      Distance_to_Shore > 10000 ~ "Mar abierto (> 10 km)"
    )
  )

# Promedio de blanqueamiento por categoria
distancia.blanq <- base.filtrada %>%
  group_by(Distancia.categoria) %>%
  summarise(prom.blanq = mean(Percent_Bleaching, na.rm = TRUE))

# Gráfico
distancia.blanq %>% 
  ggplot(aes(x = Distancia.categoria, y = prom.blanq, fill = Distancia.categoria)) +
  geom_bar(stat = "identity", show.legend = FALSE, width = 0.7) +
  labs(
    title = "Promedio de blanqueamiento coralino según la distancia a la costa (2000–2020)",
    x = "Categoría de distancia a la costa",
    y = "Porcentaje promedio de blanqueamiento (%)"
  ) +
  theme_minimal()

```
## Temperatura promedio en relación con el blanqueamiento de arrecifes
```{r}

base.filtrada <- base.filtrada %>%
  mutate(temp.cel = Temperature_Mean - 273.15)

base.filtrada %>% 
  ggplot(aes(x = temp.cel, y = Percent_Bleaching)) +
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.9, color = NA) +
  scale_fill_viridis_c(option = "magma", direction = -1, name = "Densidad de puntos") +
  #geom_smooth(method = "lm", color = "deepskyblue", linewidth = 1.2, se = FALSE) +
  labs(
    title = "Relación entre la temperatura promedio y el blanqueamiento coralino (2000–2020)",
    subtitle = "Datos del Océano Pacífico",
    x = "Temperatura promedio (°C)",
    y = "Porcentaje de blanqueamiento (%)"
  ) +
  theme_minimal()

```

## Anomalías térmicas por región en relaicón con el blanqueamiento de los arrecifes

```{r}

ssta.ecoreg <- base.filtrada %>%
  group_by(Ecoregion_Name) %>%
  summarise(
    prom.blanq = mean(Percent_Bleaching, na.rm = TRUE),
    max.ssta = mean(SSTA_Maximum, na.rm = TRUE)
  ) %>%
  arrange(desc(max.ssta))

ssta.ecoreg %>% 
  ggplot(aes(x = max.ssta, y = prom.blanq, label = Ecoregion_Name)) +
  geom_point(color = "#E53935", size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", se = TRUE, color = "#1E88E5", linewidth = 1.2) +
  geom_text(size = 3, hjust = 1.1, vjust = 0.3, color = "gray20") +
  labs(
    title = "Relación entre anomalías térmicas (SSTA máxima) y blanqueamiento coralino por ecorregión (2000–2020)",
    subtitle = "Cada punto representa una ecorregión promedio del Océano Pacífico",
    x = "Anomalía máxima de temperatura superficial (°C)",
    y = "Porcentaje promedio de blanqueamiento (%)"
  ) +
  theme_minimal()

```
## Anomalías de estrés térmico
```{r}
tsa.ecoreg <- base.filtrada %>%
  group_by(Ecoregion_Name) %>%      
  summarise(
    prom.blanq = mean(Percent_Bleaching, na.rm = TRUE),
    prom.tsa = mean(TSA_Mean, na.rm = TRUE)
  ) 

tsa.ecoreg %>% 
  ggplot(aes(x = prom.tsa, y = prom.blanq, label = Ecoregion_Name)) +
  geom_point(color = "#E53935", size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", se = TRUE, color = "#1E88E5", linewidth = 1.2) +
  geom_text(size = 3, hjust = 1.1, vjust = 0.3, color = "gray20") +
  labs(
    title = "Relación entre el estrés térmico promedio (TSA) y el blanqueamiento coralino (2000–2020)",
    subtitle = "Cada punto representa una ecorregión promedio del Océano Pacífico",
    x = "Anomalía promedio de estrés térmico (°C)",
    y = "Porcentaje promedio de blanqueamiento (%)"
  ) +
  theme_minimal()

```
## Frecuencia de ciclones por ecorregión
```{r}

library(maps)

map.data <- base.filtrada %>%
  group_by(Site_ID, Latitude_Degrees, Longitude_Degrees) %>%
  summarise(
    prom.blanq = mean(Percent_Bleaching, na.rm = TRUE),
    freq.ciclones = mean(Cyclone_Frequency, na.rm = TRUE)
  ) 

world <- map_data("world")

ggplot() +
  geom_polygon(
    data = world,
    aes(x = long, y = lat, group = group),
    fill = "gray95", color = "gray80", linewidth = 0.3
  ) +
  geom_point(
    data = map_data,
    aes(
      x = Longitude_Degrees,
      y = Latitude_Degrees,
      color = prom.blanq,
      size = freq.ciclones
    ),
    alpha = 0.8
  ) +
  scale_color_viridis_c(
    option = "magma",
    direction = -1,
    name = "Blanqueamiento (%)"
  ) +
  scale_size_continuous(
    range = c(1, 6),
    name = "Frecuencia de ciclones"
  ) +
  coord_fixed(xlim = c(110, -70), ylim = c(-50, 50)) +
  labs(
    title = "Distribución del blanqueamiento coralino y frecuencia de ciclones en el Océano Pacífico (2000–2020)",
    x = "Longitud",
    y = "Latitud"
  ) +
  theme_minimal()

```


