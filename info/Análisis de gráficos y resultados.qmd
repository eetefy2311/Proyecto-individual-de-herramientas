---
title: "Análisis de gráficos y resultados"
format: html
---

# Tratamiento de datos
```{r}
library(readr)

library(dplyr)

library(ggplot2)

url <- "https://raw.githubusercontent.com/eetefy2311/Data-proyecto-individual/refs/heads/main/global_bleaching_environmental%20(1).csv"

temp.file <- tempfile(fileext = ".csv")

download.file(url, destfile = temp.file, mode = "wb")

database <- read_csv(temp.file)

View(database)

base.filtrada <- database %>%
  select(
    Site_ID,
    Latitude_Degrees,
    Longitude_Degrees,
    Ocean_Name,
    Ecoregion_Name,
    Realm_Name,
    Exposure,
    Distance_to_Shore,
    Date_Year,
    Temperature_Mean,
    SSTA_Maximum,
    TSA_Mean,
    Turbidity,
    Cyclone_Frequency,
    Percent_Bleaching
  ) %>%
  filter(Ocean_Name == "Atlantic", Date_Year >= 2000, Date_Year <= 2020) 

base.filtrada <- base.filtrada %>%
  mutate(across(
    .cols = c(
      "Percent_Bleaching",
      "Distance_to_Shore",
      "Temperature_Mean",
      "SSTA_Maximum",
      "TSA_Mean"
    ),
    .fns = ~ as.numeric(gsub("[^0-9\\.-]", "", .x))
  ))

View(base.filtrada)

# Manejo de datos faltantes y outliers.
mediana.dist <- median(base.filtrada$Distance_to_Shore, na.rm = TRUE)
mediana.blanq <- median(base.filtrada$Percent_Bleaching, na.rm = TRUE)

base.filtrada %>%
  mutate(
    Distance_to_Shore = if_else(is.na(Distance_to_Shore), mediana.dist, Distance_to_Shore),
    Percent_Bleaching = if_else(is.na(Percent_Bleaching), mediana.blanq, Percent_Bleaching),
    Exposure = if_else(is.na(Exposure), "Desconocido", Exposure)
  )

base.filtrada %>% 
  mutate(
    Q1 = quantile(Distance_to_Shore, 0.25, na.rm = TRUE),
    Q3 = quantile(Distance_to_Shore, 0.75, na.rm = TRUE),
    IQR_val = Q3 - Q1,
    lim.inf = Q1 - 1.5 * IQR_val,
    lim.sup = Q3 + 1.5 * IQR_val,
    Distance_to_Shore = if_else(Distance_to_Shore < lim.inf | Distance_to_Shore > lim.sup,
                                mediana.dist, Distance_to_Shore)
  )
```

# Análisis de los gráficos planteados
## Tendencia de blanqueamiento de arrecifes de coral de 2000-2020

```{r}
promedio.anual <- base.filtrada %>%
  group_by(Date_Year) %>%
  summarise(prom.blanq = mean(Percent_Bleaching, na.rm = TRUE))

promedio.anual %>% 
  ggplot(aes(x = Date_Year, y = prom.blanq)) +
  geom_line(color = "#0077B6", size = 1.2) +
  geom_point(color = "#00B4D8", size = 2) +
  geom_smooth(method = "loess", se = FALSE, color = "#FF6B6B", linetype = "dashed") +
  scale_x_continuous(breaks = seq(2000, 2020, by = 2)) +
  labs(
    title = "Tendencia del blanqueamiento coralino en el Océano Atlántico (2000–2020)",
    x = "Año",
    y = "Porcentaje promedio de blanqueamiento (%)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 10.3, face = "bold"),
    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )
```


Análisis
En cuanto a la dimensión temporal, la serie de porcentaje promedio de blanqueamiento muestra dos picos muy marcados: uno alrededor de 2005 y otro entre 2014 y 2015. El máximo en 2005 coincide con un evento masivo de blanqueamiento en el Caribe y el Atlántico tropical occidental, caracterizado por una acumulación sin precedentes de estrés térmico (Eakin et al., 2010; Simonti et al., 2010). Este pulso sugiere que en años con anomalías térmicas elevadas, la respuesta de los corales es rápida y amplia, con valores regionales que alcanzaron cerca del 30–35 %. El segundo aumento (2014–2015) se alinea con el tercer evento global de blanqueamiento, donde el Atlántico-Caribe tuvo una sensibilidad mayor que otras cuencas oceánicas (Eakin et al., 2020). Entre estos picos, los valores retornan a niveles moderados, lo que puede indicar cierta recuperación de los arrecifes, aunque la recurrencia de eventos severos plantea interrogantes sobre la resiliencia a largo plazo.

## Porcentajes de blanqueamiento por ecorregión
```{r}
library(RColorBrewer)

top.ecoreg <- base.filtrada %>%
  filter(!is.na(Ecoregion_Name)) %>%
  group_by(Ecoregion_Name) %>%
  filter(n()>30) %>%
  summarise(prom.blanq = mean(Percent_Bleaching, na.rm = TRUE)) %>% 
  arrange(desc(prom.blanq)) %>%
  mutate(Ecoregion_Name = factor(Ecoregion_Name, levels = Ecoregion_Name))

cols <- rev(colorRampPalette(c("#4292C6", "#08306B"))(nrow(top.ecoreg)))

top.ecoreg %>%  
  ggplot(aes(x = Ecoregion_Name, y = prom.blanq, fill = Ecoregion_Name)) +
  geom_bar(stat = "identity", show.legend = TRUE, width = 0.7) +
  scale_fill_manual(values = cols) +  
  labs(
    title = "Promedio de blanqueamiento coralino por ecorregión (2000–2020)",
    x = "Porcentaje promedio de blanqueamiento (%)",
    y = "Ecorregión"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_blank())

```
Análisis
Espacialmente, los promedios por ecorregión revelan que las Antillas (Hispaniola–Puerto Rico–Lesser Antilles) y Belice–Caribe occidental presentan los valores más altos de blanqueamiento. Esto respalda el objetivo de comparar subregiones atlánticas: la severidad del blanqueamiento es mayor en el Caribe central-occidental que en regiones como Brasil o África occidental, lo cual sugiere que factores regionales (circulación, retención térmica, plataforma somera) modulaban la respuesta coralina.

## Exposición en relación con el porcentaje de blanqueamiento y distancia a la costa
```{r}
exposicion.pastel <- base.filtrada %>%
  filter(!is.na(Exposure)) %>%
  group_by(Exposure) %>%
  summarise(cantidad = n()) %>%
  mutate(porcentaje.pastel = round((cantidad / sum(cantidad)) * 100, 1))

exposicion.pastel %>% 
  ggplot(aes(x = "", y = porcentaje.pastel, fill = Exposure)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text(aes(label = paste0(porcentaje.pastel, "%")),
            position = position_stack(vjust = 0.5),
            color = "black",
            size = 4) +
  scale_fill_brewer(palette = "Pastel1") +
  labs(
    title = "Distribución de registros por tipo de exposición (2000–2020)",
    fill = "Tipo de exposición"
  ) +
  theme_void()

mediana.dist <- median(base.filtrada$Distance_to_Shore, na.rm = TRUE)

base.filtrada <- base.filtrada %>%
  mutate(
    Distance_to_Shore = ifelse(is.na(Distance_to_Shore), mediana.dist, Distance_to_Shore),
    Distancia.categoria = case_when(
      Distance_to_Shore <= 1000 ~ "Cercano a la costa (<= 1 km)",
      Distance_to_Shore > 1000 & Distance_to_Shore <= 10000 ~ "Intermedio (1–10 km)",
      Distance_to_Shore > 10000 ~ "Mar abierto (> 10 km)"
    )
  )

# Promedio de blanqueamiento por categoria
distancia.blanq <- base.filtrada %>%
  group_by(Distancia.categoria) %>%
  summarise(prom.blanq = mean(Percent_Bleaching, na.rm = TRUE))

distancia.blanq %>% 
  ggplot(aes(x = Distancia.categoria, y = prom.blanq, fill = Distancia.categoria)) +
  geom_bar(stat = "identity", show.legend = FALSE, width = 0.7) +
  labs(
    title = "Promedio de blanqueamiento coralino según la distancia a la costa (2000–2020)",
    x = "Categoría de distancia a la costa",
    y = "Porcentaje promedio de blanqueamiento (%)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 11),
    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )
```
Análisis
En cuanto a variables locales, se observa que los registros más altos de blanqueamiento promedio se agrupan en la categoría de distancia a la costa de 1–10 km, mientras que los sitios más abiertos (>10 km) presentan valores menores. Esto apunta a que zonas meso-costeras, donde la renovación de agua podría ser menor que mar abierto pero mayor que ultra-cercana a costa, podrían estar más vulnerables. La exposición mayoritaria de los sitios muestreados a “exposed” (~54 %) también plantea la necesidad de analizar cómo el oleaje, la radiación y la mezcla influyen en el fenómeno.

## Temperatura y anomalías térmicas en relación con el blanqueamiento coralino
```{r}
#Temperatura promedio en relación con el blanqueamiento de arrecifes
base.filtrada <- base.filtrada %>%
  mutate(temp.cel = Temperature_Mean - 273.15)

base.filtrada %>% 
  ggplot(aes(x = temp.cel, y = Percent_Bleaching)) +
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.9, color = NA) +
  scale_fill_viridis_c(option = "magma", direction = -1, name = "Densidad de puntos") +
  labs(
    title = "Relación entre la temperatura promedio y el blanqueamiento coralino (2000–2020)",
    x = "Temperatura promedio (°C)",
    y = "Porcentaje de blanqueamiento (%)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.2, size = 11),
    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )

#Anomalías térmicas por región en relación con el blanqueamiento de los arrecifes
library(ggrepel)
ssta.ecoreg <- base.filtrada %>%
  group_by(Ecoregion_Name) %>%
  summarise(
    prom.blanq = mean(Percent_Bleaching, na.rm = TRUE),
    max.ssta = mean(SSTA_Maximum, na.rm = TRUE)
  ) %>%
  arrange(desc(max.ssta))

ggplot(ssta.ecoreg, aes(x = max.ssta, y = prom.blanq, label = Ecoregion_Name)) +
  geom_point(color = "#E53935", size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", se = TRUE, color = "#1E88E5", linewidth = 1) +
  ggrepel::geom_text_repel(size = 3, color = "gray20", max.overlaps = 10) + 
  labs(
    title = "Relación entre anomalías térmicas (SSTA máxima) y blanqueamiento por ecorregión",
    x = "Anomalía máxima de temperatura superficial (°C)",
    y = "Porcentaje promedio de blanqueamiento (%)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.4, size = 10),
    plot.subtitle = element_text(hjust = 0.5, size = 9, color = "gray30"),
    plot.margin = margin(t = 15, r = 15, b = 15, l = 15)
  )
```

Análisis
Desde la perspectiva de los factores ambientales, la relación entre anomalías térmicas máximas (SSTA) y porcentaje promedio de blanqueamiento es positiva, aunque con considerable dispersión. Esto indica que si bien la SSTA es un predictor crítico, por sí sola no explica completamente la severidad del blanqueamiento. La exploración del mapa de calor de temperatura media vs blanqueamiento confirma que la temperatura promedio no es suficiente como indicador: la historia térmica, el estrés acumulado y otros moduladores son esenciales.

## Modelo random forest
```{r}
library(ranger)

set.seed(123)

datos <- base.filtrada %>%
  mutate(Lat.abs = abs(Latitude_Degrees)) %>%
  select(Percent_Bleaching, SSTA_Maximum, Cyclone_Frequency, Lat.abs, Date_Year) %>%
  drop_na()

n <- nrow(datos)
idx <- sample(seq_len(n), size = floor(0.8 * n))
train <- datos[idx, ]
test  <- datos[-idx, ]

rf.mod <- ranger(
  Percent_Bleaching ~ SSTA_Maximum + Cyclone_Frequency + Lat.abs + Date_Year,
  data = train,
  num.trees = 600,
  mtry = 3,
  min.node.size = 5,
  importance = "permutation",
  seed = 123
)

pred.test <- predict(rf.mod, data = test)$predictions

rmse <- sqrt(mean((pred.test - test$Percent_Bleaching)^2))
r2   <- cor(pred.test, test$Percent_Bleaching)^2
c(RMSE = rmse, R2 = r2)

ggplot(data.frame(obs = test$Percent_Bleaching, pred = pred.test),
       aes(x = obs, y = pred)) +
  geom_point(aes(color = pred - obs), size = 2, alpha = 0.8) +
  geom_abline(slope = 1, intercept = 0, color = "blue", linewidth = 2) +
  scale_color_viridis_c(option = "magma", direction = -1, name = "Error") +
  coord_equal(xlim = c(0, 100), ylim = c(0, 100), expand = FALSE) +
  labs(title = "Predicho vs observado (Random Forest)",
       x = "Observado (%)", y = "Predicho (%)") +
  theme_minimal(base_size = 13)

```
Explicación detallada del modelo
Durante la etapa de modelado predictivo, se implementó un algoritmo de bosque aleatorio de regresión (Random Forest) utilizando el paquete ranger en R. Este modelo tuvo como propósito estimar el porcentaje de blanqueamiento coralino a partir de variables ambientales y espaciales, con el fin de evaluar la capacidad predictiva de factores oceanográficos simples, como los que se analizaron previamente, y explorar su utilidad para identificar patrones y áreas de alta vulnerabilidad en el Atlántico.

El conjunto de datos se conformó con registros de blanqueamiento coralino (Percent_Bleaching) y cuatro predictores principales: la anomalía máxima de temperatura superficial del mar (SSTA_Maximum), la frecuencia de ciclones tropicales (Cyclone_Frequency), la latitud absoluta (Lat.abs), que representa la distancia al ecuador y el gradiente térmico asociado, y el año de registro (Date_Year), que permite capturar tendencias temporales. Se eliminaron los valores faltantes para garantizar la consistencia del entrenamiento. Posteriormente, los datos fueron divididos en dos subconjuntos: un 80 % para entrenamiento del modelo y un 20 % para su validación independiente.

El modelo se configuró con 600 árboles de decisión (num.trees = 600), cada uno ajustado sobre una muestra aleatoria de los datos. En cada nodo del árbol, el algoritmo evaluó tres variables candidatas (mtry = 3) para decidir la mejor división, lo cual incrementa la diversidad entre árboles y evita el sobreajuste. Además, se estableció un tamaño mínimo de nodo terminal de cinco observaciones (min.node.size = 5), lo que ayuda a controlar la profundidad de los árboles y a suavizar las predicciones. El parámetro de importancia por permutación se activó para cuantificar la contribución individual de cada variable al desempeño del modelo, permitiendo identificar qué factores tienen mayor peso en la predicción del blanqueamiento.

El funcionamiento del bosque aleatorio se basa en la creación de múltiples árboles de decisión construidos sobre subconjuntos aleatorios de los datos y de las variables predictoras. Cada árbol genera una estimación independiente del porcentaje de blanqueamiento, y el modelo final corresponde al promedio de todas las predicciones individuales. Este enfoque combina bagging (muestreo con reemplazo) con selección aleatoria de variables, reduciendo la varianza y permitiendo capturar relaciones no lineales e interacciones entre los predictores, sin requerir supuestos estadísticos de linealidad o normalidad.

El desempeño del modelo se evaluó mediante dos métricas: el error cuadrático medio raíz (RMSE), que mide la magnitud promedio del error en porcentaje de blanqueamiento, y el coeficiente de determinación (R²), que indica la proporción de variabilidad explicada por el modelo. Los resultados obtenidos evidenciaron que el bosque aleatorio reproduce con buena precisión los valores bajos y medios de blanqueamiento, aunque tiende a subestimar los valores más altos (superiores al 40–50 %). Esta tendencia sugiere que, si bien las variables incluidas explican parte del patrón observado, existen factores adicionales que influyen en los casos extremos y que no fueron considerados en esta configuración básica.

Para la realización del modelo, se tomó como base los artículos de Breiman (2001), sobre como funciona el bosque aleatorio para el modelaje de variables; Wright y Ziegler (2017), los cuales trabajan una implementación de la librería Ranger; y Kuh, y Johnson (2013), en cuyo artículo meutran el uso de modelos predictivos aplicados. 

Refs:
Breiman, L. (2001). Random forests. Machine Learning, 45(1), 5–32.
https://doi.org/10.1023/A:1010933404324
Wright, M. N., & Ziegler, A. (2017). ranger: A fast implementation of random forests for high dimensional data in C++ and R. Journal of Statistical Software, 77(1), 1–17.
https://doi.org/10.18637/jss.v077.i01
Kuhn, M., & Johnson, K. (2013). Applied predictive modeling. Springer.
https://doi.org/10.1007/978-1-4614-6849-3


En términos de interpretación, la anomalía térmica máxima (SSTA) y el año mostraron las mayores contribuciones al modelo, confirmando que el estrés térmico y la variabilidad interanual son los principales determinantes del blanqueamiento. Sin embargo, la magnitud del error en los valores más elevados indica que sería conveniente incorporar variables complementarias, como el índice de acumulación de calor (Degree Heating Weeks, DHW), la profundidad del arrecife, la turbidez, la exposición al oleaje o la cobertura coralina y macroalgal, que podrían capturar mejor la respuesta ecológica ante eventos extremos.

